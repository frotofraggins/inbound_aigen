# Phase 4: Database Schema & Migrations - COMPLETE ✅

**Completed:** 2026-01-09  
**Region:** us-west-2  
**Database:** ops-pipeline-db (PostgreSQL 16.11)

---

## Migration Success Summary

### Tables Created (6 total)

1. ✅ **schema_migrations** - Migration tracking
2. ✅ **inbound_events_raw** - Raw RSS feed items
3. ✅ **inbound_events_classified** - Sentiment-analyzed events
4. ✅ **feed_state** - RSS feed polling state
5. ✅ **lane_telemetry** - Market OHLCV candles
6. ✅ **dispatch_recommendations** - Trading signals

### Migration Details

**Migration Lambda:**
- Function: `ops-pipeline-db-migration`
- ARN: `arn:aws:lambda:us-west-2:160027201036:function:ops-pipeline-db-migration`
- Status: Active
- Runtime: Python 3.12
- Timeout: 60 seconds
- Memory: 512 MB
- VPC: Enabled (3 subnets, sg-0cd16a909f4e794ce)

**Execution Result:**
```json
{
  "success": true,
  "version": "001_init",
  "tables_created": [
    "dispatch_recommendations",
    "feed_state", 
    "inbound_events_classified",
    "inbound_events_raw",
    "lane_telemetry",
    "schema_migrations"
  ],
  "timestamp": "2026-01-09T23:40:46.567468"
}
```

**CloudWatch Logs:** `/aws/lambda/ops-pipeline-db-migration`

---

## Database Schema Details

### inbound_events_raw
**Purpose:** Store raw RSS feed items before classification

**Columns:**
- `id` BIGSERIAL PRIMARY KEY
- `event_uid` TEXT NOT NULL UNIQUE (sha256 of guid/link/title)
- `published_at` TIMESTAMPTZ (original publish time)
- `source` TEXT (feed URL)
- `title` TEXT NOT NULL
- `link` TEXT (article URL)
- `summary` TEXT (description)
- `fetched_at` TIMESTAMPTZ DEFAULT NOW()
- `processed_at` TIMESTAMPTZ (classification timestamp)

**Indexes:**
- `idx_inbound_raw_processed` - Find unprocessed items (WHERE processed_at IS NULL)
- `idx_inbound_raw_published` - Sort by publish time
- `idx_inbound_raw_fetched` - Sort by fetch time

---

### inbound_events_classified
**Purpose:** Store sentiment analysis results and extracted tickers

**Columns:**
- `id` BIGSERIAL PRIMARY KEY
- `raw_event_id` BIGINT REFERENCES inbound_events_raw(id)
- `tickers` TEXT[] DEFAULT '{}' (extracted symbols)
- `sentiment_label` TEXT NOT NULL (positive/negative/neutral)
- `sentiment_score` DOUBLE PRECISION NOT NULL
- `event_type` TEXT (future: earnings/merger)
- `urgency` TEXT (future: breaking/routine)
- `created_at` TIMESTAMPTZ DEFAULT NOW()
- **UNIQUE(raw_event_id)** - Each event classified once

**Indexes:**
- `idx_classified_tickers` - GIN index for array queries
- `idx_classified_created` - Sort by creation time
- `idx_classified_sentiment` - Filter by sentiment

---

### feed_state
**Purpose:** Track RSS feed metadata for efficient polling

**Columns:**
- `feed_url` TEXT PRIMARY KEY
- `etag` TEXT (HTTP ETag for conditional requests)
- `last_modified` TEXT (HTTP Last-Modified header)
- `last_seen_published` TIMESTAMPTZ (most recent article)
- `updated_at` TIMESTAMPTZ DEFAULT NOW()

---

### lane_telemetry
**Purpose:** Store market OHLCV candle data

**Columns:**
- `ticker` TEXT NOT NULL
- `ts` TIMESTAMPTZ NOT NULL
- `open`, `high`, `low`, `close` DOUBLE PRECISION NOT NULL
- `volume` BIGINT
- **PRIMARY KEY (ticker, ts)**

**Indexes:**
- `idx_telemetry_ticker_ts` - Time-series queries (ticker, ts DESC)

---

### dispatch_recommendations
**Purpose:** Store trading signals generated by signal engine

**Columns:**
- `id` BIGSERIAL PRIMARY KEY
- `ts` TIMESTAMPTZ DEFAULT NOW()
- `ticker` TEXT NOT NULL
- `action` TEXT CHECK (action IN ('BUY', 'SELL'))
- `confidence` DOUBLE PRECISION
- `reason` JSONB DEFAULT '{}'
- `status` TEXT DEFAULT 'PENDING' CHECK (status IN ('PENDING', 'EXECUTED', 'CANCELLED'))
- `executed_at` TIMESTAMPTZ
- `filled_price` DOUBLE PRECISION
- `shares` DOUBLE PRECISION

**Indexes:**
- `idx_recommendations_status_ts` - Find pending recommendations
- `idx_recommendations_ticker_ts` - Per-ticker history
- `idx_recommendations_executed` - Execution history

---

## Verification Queries

Run these to verify the schema:

```sql
-- 1. List all tables
SELECT tablename FROM pg_tables WHERE schemaname = 'public' ORDER BY tablename;

-- 2. Check table row counts
SELECT 'inbound_events_raw' as table_name, COUNT(*) as row_count FROM inbound_events_raw
UNION ALL SELECT 'inbound_events_classified', COUNT(*) FROM inbound_events_classified
UNION ALL SELECT 'feed_state', COUNT(*) FROM feed_state
UNION ALL SELECT 'lane_telemetry', COUNT(*) FROM lane_telemetry
UNION ALL SELECT 'dispatch_recommendations', COUNT(*) FROM dispatch_recommendations;

-- 3. Verify indexes
SELECT indexname, tablename 
FROM pg_indexes 
WHERE schemaname = 'public' 
ORDER BY tablename, indexname;

-- 4. Check foreign keys
SELECT conname, conrelid::regclass AS table_name, confrelid::regclass AS referenced_table
FROM pg_constraint 
WHERE contype = 'f';

-- 5. Verify check constraints
SELECT conname, conrelid::regclass AS table_name, pg_get_constraintdef(oid) AS definition
FROM pg_constraint 
WHERE contype = 'c';

-- 6. Check applied migrations
SELECT * FROM schema_migrations ORDER BY applied_at;
```

---

## Why Migrations Are Separate from Application Services

**Separation of Concerns:**
1. **One-Time vs Continuous** - Migrations run once; services run forever
2. **Different Failure Modes** - Migration failure = stop deployment; service failure = retry
3. **Version Control** - Schema changes tracked separately from code
4. **Rollback Safety** - Can roll back code without touching DB schema
5. **Audit Trail** - `schema_migrations` table tracks what was applied when

**Idempotency:**
- All CREATE statements use `IF NOT EXISTS`
- Safe to re-run without errors
- `schema_migrations` table prevents duplicate application

---

## Next Steps

**Phase 4 Complete!** ✅ Ready to build the data pipeline:

### Phase 5: RSS Ingestion Lambda (Next)
- Pull RSS feeds every 1 minute
- Write to `inbound_events_raw` table
- Update `feed_state` table

### Phase 6: Classification Worker Container
- Poll `inbound_events_raw` WHERE `processed_at IS NULL`
- Run FinBERT sentiment analysis
- Extract tickers
- Write to `inbound_events_classified`

### Phase 7: Market Telemetry Lambda
- Fetch candles with yfinance
- Write to `lane_telemetry` table

### Phase 8: Signal Engine Lambda
- Combine classified events + telemetry
- Generate BUY/SELL signals
- Write to `dispatch_recommendations`

---

## Cost Update

**Monthly Costs So Far:**
- Secrets Manager: $0.40
- SSM Parameters: $0.00 (free)
- RDS db.t3.micro: ~$13.50
- RDS storage (20GB gp3): ~$1.60
- VPC Endpoints (2): ~$15/month
- S3: ~$0.10 (minimal data)
- Lambda executions: ~$0.00 (free tier)

**Total: ~$30.60/month** (above original $25 budget, but VPC endpoints necessary)

---

**Ready to proceed to Phase 5: RSS Ingestion Lambda?**
